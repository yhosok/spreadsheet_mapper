# Googleスプレッドシート 形式変換スクリプト

このプロジェクトは、Googleスプレッドシート上で特定のCSVデータ（フォーマットA）を、定義されたマッピングに基づき別のCSV形式（フォーマットB）へ変換するGoogle Apps Scriptです。

## 🚀 機能（v2.0.0）

### 1. 基本的な1対1マッピング
- 従来の基本的なフィールドマッピング機能

### 2. 複数フィールド結合機能
- **機能**: 複数のINPUTフィールドを1つのOUTPUTフィールドに結合
- **形式**: `フィールド1+フィールド2+フィールド3`
- **用途**: 住所の結合、名前の結合など

### 3. 固定値設定機能
- **機能**: 特定フィールドに固定値を設定
- **形式**: `[FIXED:値]` または `[FIXED]`（設定値列で指定）
- **用途**: ステータス、作成者、処理日時など

### 4. 柔軟なマッピング形式
- **2列形式**: 基本的なマッピング（従来形式）
- **4列形式**: 拡張機能を含むマッピング
- **自動判定**: 使用されている形式を自動で判定

## 機能概要

- **フォーマットA**のデータを**フォーマットB**に自動変換
- Googleスプレッドシート上でのワンクリック実行
- 項目マッピングの柔軟な設定
- **複数フィールド結合**と**固定値設定**に対応
- **後方互換性**：既存のマッピングシートもそのまま動作
- エラーハンドリングとユーザー通知

## 📁 プロジェクト構成

```
spreadsheet_mapper/
├── all-in-one.gs                    # 統合されたメインスクリプト（推奨）
├── src/                             # モジュール化されたソースコード
│   ├── main.gs                      # メイン処理とエントリーポイント
│   ├── mapping.gs                   # マッピング処理とデータ変換
│   ├── menu.gs                      # スプレッドシート用メニュー
│   └── utils.gs                     # ユーティリティ関数
├── sample/                          # サンプルデータ
│   ├── sample_data.csv              # 基本サンプルデータ
│   ├── sample_data_extended.csv     # 拡張機能サンプルデータ
│   └── mapping_example_extended.csv # 拡張マッピングサンプル
├── docs/                            # ドキュメント
│   ├── setup_guide.md               # セットアップガイド
│   └── extended_features_guide.md   # 拡張機能詳細ガイド
├── README.md                        # このファイル
├── project_structure.md             # プロジェクト詳細構造
└── 仕様書.md                        # 実装仕様書
```

## 🛠️ 技術的な構成

### アーキテクチャ概要
このプロジェクトは、Google Apps Scriptを使用したイベント駆動型のデータ変換システムです。

### 主要モジュール構造

#### 1. main.gs - メイン処理モジュール
- **convertData()**: データ変換のメイン処理
- **createHeaderRow()**: 出力ヘッダー行の作成
- **processDataRow()**: データ行の個別処理
- **onOpen()**: スプレッドシート開始時の初期化

#### 2. mapping.gs - マッピング処理モジュール
- **getMappingData()**: マッピングデータの取得と検証
- **parseMappingRow()**: マッピング行の解析
- **convertFieldValue()**: フィールド値の変換処理
- **validateMappingData()**: マッピングデータの検証

#### 3. utils.gs - ユーティリティモジュール
- **logMessage()**: ログ出力
- **showError()**: エラー表示
- **isValidRange()**: 範囲検証
- **formatDateTime()**: 日時フォーマット

#### 4. menu.gs - UIモジュール
- **createMenu()**: メニューの作成
- **showHelp()**: ヘルプの表示

### データ構造

#### マッピングオブジェクト
```javascript
{
  sourceFields: string[],    // 入力フィールド名の配列
  targetField: string,       // 出力フィールド名
  type: string,             // 変換タイプ（'BASIC'|'CONCAT'|'FIXED'）
  config: string            // 設定値（固定値や区切り文字など）
}
```

#### 変換設定オブジェクト
```javascript
{
  separator: string,        // 結合時の区切り文字（デフォルト：' '）
  fixedValue: string,      // 固定値設定時の値
  emptyValue: string       // 空値時の代替値（デフォルト：''）
}
```

### エラーハンドリング
- **ValidationError**: マッピングデータの検証エラー
- **ConversionError**: データ変換エラー
- **SystemError**: システムレベルエラー

### ログ機能
- **INFO**: 正常な処理の記録
- **WARN**: 警告レベルの記録
- **ERROR**: エラーレベルの記録
- Google Apps Scriptのログ機能を使用

### セキュリティ
- スプレッドシート内データのみアクセス
- 外部APIアクセスなし
- ユーザー権限に基づいたアクセス制御
    └── extended_features_guide.md # 拡張機能詳細ガイド
```

## 🔧 実装の詳細

### データフロー
1. **データ取得**: スプレッドシートからINPUTデータとマッピング情報を取得
2. **マッピング解析**: マッピングデータを解析し、変換ルールを構築
3. **データ変換**: 各データ行を変換ルールに従って処理
4. **結果出力**: 変換結果をOUTPUTシートに書き込み

### 変換処理の流れ
```
INPUT行 → マッピング適用 → 値変換 → OUTPUT行
    ↓
[フィールド1, フィールド2, ...] → [変換ルール] → [出力フィールド1, 出力フィールド2, ...]
```

### パフォーマンス考慮事項
- **バッチ処理**: 行単位でなく配列単位での処理
- **メモリ効率**: 大容量データに対応した処理方式
- **エラー継続**: 1行のエラーで全体が停止しない設計

### 拡張性
- **プラグイン対応**: 新しい変換タイプの追加が容易
- **カスタム関数**: ユーザー定義変換関数の追加可能
- **UI拡張**: メニューとダイアログの追加が簡単

## 📖 セットアップガイド

### 1. Googleスプレッドシートの準備

#### 1.1 新しいスプレッドシートの作成
1. [Google Sheets](https://sheets.google.com)にアクセス
2. 「空白」を選択して新しいスプレッドシートを作成
3. スプレッドシートに分かりやすい名前を付ける（例：「フォーマット変換ツール」）

#### 1.2 必要なシートの作成
以下の3つのシートを作成します：

**A. INPUT シート**
1. シート名を「INPUT」に変更
2. A1セルから、変換したいデータのヘッダー行を入力
3. A2セル以降に実際のデータを入力

**例：**
```
A1: 出荷日      B1: 顧客名        C1: 商品コード    D1: 数量    E1: 単価
A2: 2024-01-15  B2: 株式会社A     C2: PROD001      D2: 10      E2: 1000
A3: 2024-01-16  B3: 株式会社B     C3: PROD002      D3: 5       E3: 2000
```

**B. 項目マッピング シート**
1. 新しいシートを追加し、名前を「項目マッピング」に変更
2. マッピング定義を入力（詳細は下記参照）

**C. OUTPUT シート**
- 変換結果が自動で出力されるシート（手動作成不要）

### 2. Google Apps Scriptの設定

#### 方法1: 統合版ファイルを使用（推奨）

1. Googleスプレッドシートで「拡張機能」→「Apps Script」を選択
2. `all-in-one.gs`ファイルの内容を全てコピーしてApps Scriptエディタに貼り付け
3. ファイルを保存（Ctrl+S または Cmd+S）

**✅ 注意**: このファイルは全ての機能（基本機能 + 拡張機能）を含んでいます。既存のマッピングシートも自動的に認識して動作します。

#### 方法2: 個別ファイルを使用

1. Googleスプレッドシートで「拡張機能」→「Apps Script」を選択
2. `src/`フォルダ内の各`.gs`ファイルの内容をApps Scriptエディタにコピー
3. ファイルを保存

### 3. 項目マッピングシートの設定

`項目マッピング`に以下の形式でマッピングを定義します。**必ずヘッダー行を含めてください。**

#### 基本形式（2列）- 従来の形式
| A列（フォーマットA項目名） | B列（フォーマットB項目名） |
|:-------------------------|:-------------------------|
| フォーマットA項目名        | フォーマットB項目名        |
| 出荷日                   | shipping_date            |
| 顧客名                   | customer_name            |
| 商品コード               | product_code             |
| 数量                     | quantity                 |

#### 拡張形式（4列）- 新機能を使用する場合
| A列（フォーマットA項目名） | B列（フォーマットB項目名） | C列（変換タイプ） | D列（設定値） |
|:-------------------------|:-------------------------|:---------------|:-------------|
| フォーマットA項目名        | フォーマットB項目名        | 変換タイプ      | 設定値       |
| 出荷日                   | shipping_date            | NORMAL         |             |
| 顧客名                   | customer_name            | NORMAL         |             |
| 住所1+住所2+住所3        | full_address             | CONCAT         | 、          |
| [FIXED:処理済み]         | status                   | FIXED          |             |

### 4. 実行方法

1. スプレッドシートに戻る
2. カスタムメニュー「📊 フォーマット変換ツール」が表示される
3. 「🔄 フォーマット変換を実行」をクリック

## 📋 拡張機能の使用方法

### 1. 複数フィールド結合（CONCAT）

複数のINPUTフィールドを1つのOUTPUTフィールドに結合します。

**使用方法**: `フィールド1+フィールド2+フィールド3`

**例**:
```
住所1+住所2+住所3 → full_address （区切り文字: 、）
姓+名 → full_name （区切り文字: " "）
```

### 2. 固定値設定（FIXED）

特定のフィールドに固定値を設定します。

**使用方法**: 
- `[FIXED:値]` - 値を直接指定
- `[FIXED]` - 設定値列で指定

**例**:
```
[FIXED:処理済み] → status
[FIXED] → created_by （設定値: システム自動）
```

### 3. 自動判定機能

- 2列形式と4列形式を自動判定
- 変換タイプを自動推測（省略可能）
- 完全な後方互換性

## 🔧 詳細な使用例

### 実践的なマッピング例

**入力データ例**:
```csv
出荷日,顧客名,住所1,住所2,住所3,商品コード,数量,備考
2024-01-15,株式会社A,東京都,新宿区,1-1-1,PROD001,10,通常出荷
2024-01-16,株式会社B,大阪府,大阪市,中央区2-2-2,PROD002,5,急ぎ
```

**マッピング設定例**:
```csv
フォーマットA項目名,フォーマットB項目名,変換タイプ,設定値
出荷日,shipping_date,NORMAL,
顧客名,customer_name,NORMAL,
住所1+住所2+住所3,full_address,CONCAT,
商品コード,product_code,NORMAL,
数量,quantity,NORMAL,
[FIXED:処理済み],status,FIXED,
[FIXED],created_by,FIXED,システム自動
備考,notes,NORMAL,
```

**変換結果例**:
```csv
shipping_date,customer_name,full_address,product_code,quantity,status,created_by,notes
2024-01-15,株式会社A,東京都新宿区1-1-1,PROD001,10,処理済み,システム自動,通常出荷
2024-01-16,株式会社B,大阪府大阪市中央区2-2-2,PROD002,5,処理済み,システム自動,急ぎ
```

## ⚠️ 注意事項

### 一般的な注意事項
- **項目名の重複**は避けてください（フォーマットB項目名）
- **空行**は作らないでください
- **ヘッダー行**は必ず含めてください
- **フォーマットB項目名が空**の場合、そのマッピングはスキップされます（エラーになりません）

### 拡張機能の注意事項
- **結合フィールド**: 最低2つ以上のフィールドが必要
- **固定値**: 任意の文字を使用可能（改行文字も可）
- **区切り文字**: 未指定の場合は直接結合されます
- **文字種制限**: フィールド名に文字種制限はありません

## 🆘 トラブルシューティング

### よくあるエラーと解決法

**「CONCATタイプでは複数のソースフィールドが必要です」**
- 原因: 結合フィールドが1つしか指定されていない
- 解決: `+` で複数フィールドを結合する

**「FIXEDタイプでは固定値の設定が必要です」**
- 原因: 固定値が設定されていない
- 解決: `[FIXED:値]` 形式で値を指定するか、設定値列に記入

**「以下の項目が入力シートに見つかりません」**
- 原因: 結合フィールドの一部が入力シートに存在しない
- 解決: 入力シートのヘッダー名を確認し、マッピングを修正

## 📚 参考資料

- **詳細な使用例**: `docs/extended_features_guide.md`
- **セットアップガイド**: `docs/setup_guide.md`
- **サンプルデータ**: `sample/` フォルダ内のファイル
| [FIXED]                  | created_by               | FIXED          | システム自動 |

#### 重要なポイント

1. **自動判定**: システムが使用している形式を自動で判定します
2. **後方互換性**: 既存の2列形式のマッピングシートはそのまま動作します
3. **混在可能**: 同じシート内で基本形式と拡張形式を混在させることができます

#### 拡張機能の使用例

**複数フィールド結合**:
```
住所1+住所2+住所3 → full_address
```
- 結果: `東京都新宿区1-1-1`

**固定値設定**:
```
[FIXED:処理済み] → status
```
- 結果: 全行に `処理済み` が設定

**区切り文字付き結合**:
```
姓+名 → full_name (設定値: " ")
```
- 結果: `田中 太郎`

### 4. シート名のカスタマイズ（オプション）

デフォルトのシート名を変更したい場合は、スクリプト内の設定を変更できます：

```javascript
const SHEET_NAMES = {
  INPUT: 'INPUT',           // 入力シート名
  MAPPING: '項目マッピング',  // マッピングシート名
  OUTPUT: 'OUTPUT'          // 出力シート名
};
```

## 📝 使用手順

### 基本的な使用フロー

1. **データ準備**: `INPUT`シートにデータを入力
2. **マッピング設定**: `項目マッピング`シートでフィールドの対応関係を定義
3. **変換実行**: カスタムメニューから「🔄 フォーマット変換を実行」を選択
4. **結果確認**: `OUTPUT`シートで変換結果を確認

### メニューの説明

- **🔄 フォーマット変換を実行**: メイン変換処理
- **🔍 マッピング検証**: マッピング設定の検証
- **👀 変換プレビュー**: 変換結果のプレビュー（少数行）
- **🧹 OUTPUTシートクリア**: 出力シートの内容をクリア
- **📚 使用方法**: 使用方法の表示

## 🎯 よくある使用パターン

### パターン1: 基本的な項目変換
```csv
フォーマットA項目名,フォーマットB項目名
出荷日,shipping_date
顧客名,customer_name
商品コード,product_code
```

### パターン2: 住所の結合
```csv
フォーマットA項目名,フォーマットB項目名,変換タイプ,設定値
住所1+住所2+住所3,full_address,CONCAT,
```

### パターン3: 固定値の追加
```csv
フォーマットA項目名,フォーマットB項目名,変換タイプ,設定値
[FIXED:処理済み],status,FIXED,
[FIXED],created_by,FIXED,システム自動
```

### パターン4: 複合的な変換
```csv
フォーマットA項目名,フォーマットB項目名,変換タイプ,設定値
出荷日,shipping_date,NORMAL,
顧客名,customer_name,NORMAL,
住所1+住所2+住所3,full_address,CONCAT,、
商品コード,product_code,NORMAL,
[FIXED:処理済み],status,FIXED,
[FIXED],created_by,FIXED,システム自動
```

### パターン5: 選択的なマッピング（一部項目のみ出力）
```csv
フォーマットA項目名,フォーマットB項目名,変換タイプ,設定値
出荷日,shipping_date,NORMAL,
顧客名,customer_name,NORMAL,
商品コード,,NORMAL,
数量,quantity,NORMAL,
合計金額,,NORMAL,
[FIXED:処理済み],status,FIXED,
```
**結果**: 商品コードと合計金額はOUTPUTに出力されません（フォーマットB項目名が空のため）

- **INPUT** → 任意の名前
- **項目マッピング** → 任意の名前  
- **OUTPUT** → 任意の名前

詳細は「カスタマイズ」セクションをご確認ください。

## 🎯 使用方法

### 推奨：統合版を使用（all-in-one.gs）
**`all-in-one.gs` 1つのファイルで全ての機能（基本・拡張）が利用可能です。**

### 重要：拡張版ファイルについて
- `all-in-one-extended.gs` は開発時の一時的なファイルです
- 現在は `all-in-one.gs` に統合されているため、**`all-in-one.gs`のみ使用**してください
- 統合版は完全に後方互換性があります

## 📋 セットアップ手順

1. **Googleスプレッドシートを開く**
2. **「拡張機能」→「Apps Script」を選択**
3. **`all-in-one.gs`の内容をコピー&ペースト**
4. **ファイルを保存**
5. **スプレッドシートに戻ると「📊 フォーマット変換ツール」メニューが追加されます**

## 使用方法

### 1. データの準備

1. `INPUT`に変換したいデータを貼り付けます
   - 1行目：ヘッダー行（項目名）
   - 2行目以降：実際のデータ

### 2. 変換の実行

1. スプレッドシートのメニューから「カスタムメニュー」→「フォーマット変換実行」を選択
2. 処理完了のメッセージが表示されるまで待機
3. `OUTPUT`に変換結果が出力されます

### 3. 結果の確認

- `OUTPUT`が自動生成されます
- 1行目：フォーマットBの項目名
- 2行目以降：変換されたデータ

## サンプルデータ

### 基本版サンプル
`sample/sample_data.csv`にサンプルデータを用意しています。

### 拡張版サンプル
`sample/sample_data_extended.csv`と`sample/mapping_example_extended.csv`に拡張機能を使用したサンプルを用意しています。

### フォーマットAサンプル（拡張版）

```csv
出荷日,顧客名,住所1,住所2,住所3,商品コード,数量,単価,合計金額,備考
2024-01-15,株式会社A,東京都,新宿区,1-1-1,PROD001,10,1000,10000,通常出荷
2024-01-16,株式会社B,大阪府,大阪市,中央区2-2-2,PROD002,5,2000,10000,急ぎ
```

### マッピング例（拡張版）

```csv
フォーマットA項目名,フォーマットB項目名,変換タイプ,設定値
出荷日,shipping_date,NORMAL,
顧客名,customer_name,NORMAL,
住所1+住所2+住所3,full_address,CONCAT,
商品コード,product_code,NORMAL,
数量,quantity,NORMAL,
[FIXED:処理済み],status,FIXED,
[FIXED],created_by,FIXED,システム自動
```

### 変換結果例

```csv
shipping_date,customer_name,full_address,product_code,quantity,status,created_by
2024-01-15,株式会社A,東京都新宿区1-1-1,PROD001,10,処理済み,システム自動
2024-01-16,株式会社B,大阪府大阪市中央区2-2-2,PROD002,5,処理済み,システム自動
```

## エラーハンドリング

以下の場合にエラーメッセージが表示されます：

- 必要なシートが存在しない場合
- INPUTにデータが存在しない場合
- 項目マッピングの設定に不備がある場合

## 🔧 開発者向け情報

### 実装上の注意点

#### 1. Google Apps Script制限事項
- **実行時間制限**: 6分間の実行時間制限
- **メモリ制限**: 大量データ処理時のメモリ使用量
- **API制限**: スプレッドシートAPIの読み書き制限

#### 2. 推奨される実装パターン
- **バッチ処理**: `getValues()` / `setValues()` を使用
- **エラーハンドリング**: try-catch文での適切なエラー処理
- **ログ出力**: `console.log()` を使用したデバッグ

#### 3. カスタマイズポイント

**新しい変換タイプの追加**
```javascript
// mapping.gs内のconvertFieldValue関数を拡張
case 'CUSTOM_TYPE':
  return customConversionFunction(values, config);
```

**カスタム検証ルールの追加**
```javascript
// mapping.gs内のvalidateMappingData関数を拡張
function validateCustomRules(mappingData) {
  // カスタム検証ロジック
}
```

#### 4. デバッグ方法
- **Google Apps Scriptエディタ**: 組み込みデバッガーを使用
- **ログ確認**: `表示 > ログ` でログを確認
- **実行トランスクリプト**: 実行履歴の確認

### テスト方法

#### 1. 単体テスト
```javascript
function testMappingParser() {
  const testData = [['field1', 'output1', 'BASIC', '']];
  const result = getMappingData(testData);
  console.log('Test result:', result);
}
```

#### 2. 統合テスト
- サンプルデータでの全体テスト
- 各機能の動作確認
- エラーケースの検証

### 貢献方法

#### 1. 機能追加の流れ
1. 機能仕様の検討
2. コードの実装
3. テストの実施
4. ドキュメントの更新

#### 2. バグ報告
- 再現手順の記述
- 期待される動作と実際の動作
- エラーメッセージの共有

## トラブルシューティング

### 「権限が必要です」と表示される場合

1. Apps Scriptの初回実行時に権限の許可が必要です
2. 「権限を確認」をクリックし、Googleアカウントでログイン
3. 「詳細」→「安全ではないページに移動」→「許可」を選択

### 変換が正しく動作しない場合

1. 項目マッピングの設定を確認
2. INPUTのヘッダー行が正しく設定されているか確認
3. データに空白行や特殊文字が含まれていないか確認

## カスタマイズ

### シート名の変更

デフォルトのシート名を変更する場合は、`all-in-one.gs`内の以下の部分を編集してください：

```javascript
// シート名の設定（カスタマイズ可能）
const SHEET_NAMES = {
  INPUT: 'INPUT',      // 入力シート名
  MAPPING: '項目マッピング',  // マッピングシート名
  OUTPUT: 'OUTPUT'      // 出力シート名
};
```

### 新しい項目を追加する場合

1. `項目マッピング`に新しい行を追加
2. A列にフォーマットAの項目名、B列にフォーマットBの項目名を入力
3. スクリプトを再実行

### データ変換ロジックを変更する場合

統合版では`convertData`関数、個別版では`src/mapping.gs`の`transformData`関数を編集してください。

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## サポート

質問や問題がある場合は、プロジェクトの管理者にお問い合わせください。
