# Googleスプレッドシート フォーマット変換ツール 仕様書

**バージョン**: 2.0.0（緩和版）  
**更新日**: 2025年7月8日  

## 1. プロジェクト概要

### 1.1 目的
Googleスプレッドシート上で、CSVデータの形式変換を行うGoogle Apps Scriptツール。
フォーマットA（入力）→ フォーマットB（出力）への項目マッピングによる変換を提供。

### 1.2 主要特徴
- **緩和されたバリデーション**: フィールド名の文字種・長さ制限なし、空欄データ許容
- **選択的マッピング**: OUTPUTフィールドが空の場合はスキップ（エラーにしない）
- **警告とエラーの分離**: 警告のみで処理継続、エラーで処理停止
- **拡張機能**: 複数フィールド結合、固定値設定、プレビュー機能

## 2. システム構成

### 2.1 ファイル構成
```
spreadsheet_mapper/
├── all-in-one.gs                      # 統合版スクリプト（推奨）
├── src/                               # 個別ファイル版（分割管理用）
│   ├── main.gs                        # メイン処理
│   ├── mapping.gs                     # マッピング・変換処理
│   ├── menu.gs                        # UI・カスタムメニュー
│   └── utils.gs                       # ユーティリティ関数
├── sample/                            # サンプルデータ
│   ├── sample_data_extended.csv       # 拡張版サンプル
│   └── mapping_example_extended.csv   # マッピング例（OUTPUT空含む）
├── README.md                          # 使用方法ガイド
└── 仕様書.md                          # 本ファイル
```

### 2.2 スプレッドシート構成
- **INPUT**: 入力データシート（ヘッダー行 + データ行）
- **項目マッピング**: マッピング定義シート（2列 or 4列形式）
- **OUTPUT**: 出力データシート（自動生成）

## 3. 機能仕様

### 3.1 基本機能
- **1対1マッピング**: `入力項目名` → `出力項目名`
- **空欄データ許容**: null, undefined, 空文字も処理対象
- **選択的マッピング**: 出力項目名が空の場合はスキップ（エラーにしない）

### 3.2 拡張機能（v2.0.0）
- **複数フィールド結合**: `項目1+項目2+項目3` → 結合値（区切り文字指定可）
- **固定値設定**: `[FIXED:値]` → 全行に同じ値
- **プレビュー機能**: 実行前に最初の3行を確認

### 3.3 緩和されたバリデーション
- **フィールド名制限撤廃**: 任意の文字種・長さを許容
- **警告とエラーの分離**: 
  - エラー → 処理停止
  - 警告 → メッセージ表示後、処理継続
- **存在しない項目への対応**: 警告表示のみで処理継続

## 4. マッピング形式

### 4.1 基本形式（2列）
| A列: 入力項目名 | B列: 出力項目名 |
|---|---|
| 出荷日 | shipping_date |
| 顧客名 | customer_name |

### 4.2 拡張形式（4列）
| A列: 入力項目名 | B列: 出力項目名 | C列: 変換タイプ | D列: 設定値 |
|---|---|---|---|
| 住所1+住所2+住所3 | full_address | CONCAT | 、 |
| [FIXED:処理済み] | status | FIXED | |
| 顧客名 | | | | ← 空の場合はスキップ

### 4.3 変換タイプ
- **NORMAL**: 1対1マッピング（デフォルト）
- **CONCAT**: 複数フィールド結合（`+`で連結指定）
- **FIXED**: 固定値設定（`[FIXED:値]`形式）

## 5. 使用方法

### 5.1 セットアップ
1. Googleスプレッドシートを作成
2. 「拡張機能」→「Apps Script」で`all-in-one.gs`をコピー&ペースト
3. 権限許可後、スプレッドシートにカスタムメニューが表示

### 5.2 基本操作
1. **INPUT**シートに変換したいデータを配置
2. **項目マッピング**シートにマッピング定義を作成
3. メニューから「マッピング検証」で設定確認
4. 「変換プレビュー」で結果確認
5. 「フォーマット変換実行」で変換実行

## 6. 重要な仕様変更（v2.0.0緩和版）

### 6.1 バリデーション緩和
- フィールド名の文字種制限・長さ制限を撤廃
- 空欄データを許容（null, undefined, 空文字も処理対象）
- 存在しない項目は警告表示のみで処理継続

### 6.2 選択的マッピング
- 出力項目名（B列）が空の場合はそのマッピングをスキップ
- エラーにならずログで通知

### 6.3 警告とエラーの分離
- **エラー**: 処理停止（重複出力項目名、必須設定不備など）
- **警告**: 処理継続（存在しない項目、未使用列など）

## 7. トラブルシューティング

### 7.1 よくある問題
- **権限エラー**: 初回実行時に権限許可が必要
- **シート名エラー**: INPUT、項目マッピングシートの名前確認
- **データなしエラー**: 入力シートにヘッダー行とデータ行があるか確認

### 7.2 デバッグ方法
- Apps Scriptエディタの実行ログを確認
- 「マッピング検証」機能で設定の妥当性をチェック
- 「変換プレビュー」機能で結果を事前確認

---

**作成者**: 開発チーム  
**関連文書**: README.md, all-in-one.gs, src/
